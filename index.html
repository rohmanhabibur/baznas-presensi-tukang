<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Presensi Tukang - BAZNAS Banyuwangi</title>
    <meta name="description" content="Sistem Presensi Digital untuk Tukang BAZNAS Banyuwangi">
    <meta name="theme-color" content="#059669">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .loading { 
            border: 3px solid #f3f3f3;
            border-top: 3px solid #059669;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .status-online { 
            background: #10b981;
            animation: pulse 2s infinite;
        }
        .status-offline { background: #6b7280; }
        .status-warning { 
            background: #f59e0b;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .online-indicator {
            animation: blink 1.5s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .setup-form {
            transition: all 0.5s ease;
        }
        .setup-form.hidden-setup {
            opacity: 0;
            transform: translateY(-20px);
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        
        @media (max-width: 768px) {
            .mobile-padding { padding: 1rem; }
            .mobile-text { font-size: 0.875rem; }
        }
        
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-blue-50 min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in card-hover">
            <div class="text-center mb-8">
                <div class="bg-gradient-to-br from-green-600 to-green-700 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                    <span class="text-white text-2xl font-bold">B</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">BAZNAS Banyuwangi</h1>
                <p class="text-gray-600 mt-2">Sistem Presensi Digital Tukang</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Masukkan username" autocomplete="username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <div class="relative">
                        <input type="password" id="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent pr-12" placeholder="Masukkan password" autocomplete="current-password">
                        <button type="button" onclick="togglePassword()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <span id="passwordToggleIcon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                
                <button onclick="login()" id="loginBtn" class="btn-primary w-full text-white py-3 rounded-lg font-medium transition-all flex items-center justify-center">
                    <span id="loginText">Masuk</span>
                    <div id="loginLoading" class="loading ml-2 hidden"></div>
                </button>
            </div>
            
            <!-- Setup Google Sheets -->
            <div id="setupForm" class="setup-form mt-6 p-4 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border border-blue-200">
                <h3 class="font-semibold text-blue-800 mb-2 flex items-center">
                    <span class="mr-2">‚öôÔ∏è</span>
                    Konfigurasi Google Sheets
                </h3>
                <div class="space-y-2">
                    <input type="url" id="sheetsUrl" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" 
                           placeholder="https://script.google.com/macros/s/YOUR_ID/exec">
                    <div class="flex space-x-2">
                        <button onclick="testConnection()" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700 transition-colors">
                            üîç Test
                        </button>
                        <button onclick="saveSetup()" class="flex-1 btn-primary text-white py-2 px-3 rounded text-sm transition-all">
                            üíæ Simpan
                        </button>
                        <button onclick="showSetupForm()" id="showSetupBtn" class="hidden flex-1 bg-gray-600 text-white py-2 px-3 rounded text-sm hover:bg-gray-700 transition-colors">
                            ‚öôÔ∏è Setup
                        </button>
                    </div>
                </div>
                <div class="mt-2 text-xs text-gray-600">
                    <p><strong>Nama Spreadsheet:</strong> "Presensi Tukang BAZNAS Banyuwangi"</p>
                    <p><strong>Sheets:</strong> Admin, Tukang, Presensi, Settings</p>
                    <p><strong>Default Login:</strong> admin / admin123</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminPage" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="bg-gradient-to-br from-green-600 to-green-700 w-10 h-10 rounded-full flex items-center justify-center mr-3 shadow-lg">
                            <span class="text-white font-bold">B</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Dashboard Admin</h1>
                            <p class="text-sm text-gray-600" id="adminInfo">BAZNAS Banyuwangi</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="connectionStatus" class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-gray-400 rounded-full mr-2"></div>
                            <span>Offline</span>
                        </div>
                        <div id="onlineUsers" class="flex items-center text-sm bg-green-50 px-3 py-1 rounded-full">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 online-indicator"></div>
                            <span id="onlineCount">0</span> Online
                        </div>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="bg-blue-100 p-3 rounded-full">
                            <span class="text-blue-600 text-xl">üë•</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Total Tukang</p>
                            <p class="text-2xl font-bold text-gray-900" id="totalTukang">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="bg-green-100 p-3 rounded-full">
                            <span class="text-green-600 text-xl">‚úÖ</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Hadir Hari Ini</p>
                            <p class="text-2xl font-bold text-gray-900" id="hadirHariIni">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover border-l-4 border-yellow-500">
                    <div class="flex items-center">
                        <div class="bg-yellow-100 p-3 rounded-full">
                            <span class="text-yellow-600 text-xl">‚è∞</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Terlambat</p>
                            <p class="text-2xl font-bold text-gray-900" id="terlambat">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm p-6 card-hover border-l-4 border-red-500">
                    <div class="flex items-center">
                        <div class="bg-red-100 p-3 rounded-full">
                            <span class="text-red-600 text-xl">‚ùå</span>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Tidak Hadir</p>
                            <p class="text-2xl font-bold text-gray-900" id="tidakHadir">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-xl shadow-sm mb-6">
                <div class="border-b border-gray-200">
                    <nav class="flex space-x-8 px-6 overflow-x-auto">
                        <button onclick="showTab('presensi')" id="tabPresensi" class="py-4 px-1 border-b-2 border-green-500 font-medium text-sm text-green-600 whitespace-nowrap">
                            üìã Presensi Hari Ini
                        </button>
                        <button onclick="showTab('tukang')" id="tabTukang" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap">
                            üë∑ Data Tukang
                        </button>
                        <button onclick="showTab('admin')" id="tabAdmin" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap">
                            üë®‚Äçüíº Data Admin
                        </button>
                        <button onclick="showTab('monitoring')" id="tabMonitoring" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap">
                            üìä Monitoring
                        </button>
                        <button onclick="showTab('laporan')" id="tabLaporan" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap">
                            üìà Laporan
                        </button>
                        <button onclick="showTab('export')" id="tabExport" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap">
                            üíæ Export Data
                        </button>
                    </nav>
                </div>

                <!-- Presensi Tab -->
                <div id="presensiTab" class="p-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Presensi Hari Ini</h2>
                            <p class="text-sm text-gray-600 mt-1" id="currentDate"></p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="refreshData()" class="bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center text-sm">
                                <span>üîÑ</span>
                                <span class="ml-1">Refresh</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Keluar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                </tr>
                            </thead>
                            <tbody id="presensiTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Memuat data presensi...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Data Tukang Tab -->
                <div id="tukangTab" class="p-6 hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Data Tukang</h2>
                            <p class="text-sm text-gray-600 mt-1">Kelola data tukang dan informasi kontak</p>
                        </div>
                        <button onclick="showAddTukangModal()" class="btn-primary text-white px-4 py-2 rounded-lg transition-all">
                            + Tambah Tukang
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="tukangGrid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">Memuat data tukang...</p>
                        </div>
                    </div>
                </div>

                <!-- Data Admin Tab -->
                <div id="adminTab" class="p-6 hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Data Admin</h2>
                            <p class="text-sm text-gray-600 mt-1">Kelola akun administrator sistem</p>
                        </div>
                        <button onclick="showAddAdminModal()" class="btn-primary text-white px-4 py-2 rounded-lg transition-all">
                            + Tambah Admin
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="adminGrid">
                        <div class="text-center py-8 col-span-full">
                            <p class="text-gray-500">Memuat data admin...</p>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Tab -->
                <div id="monitoringTab" class="p-6 hidden">
                    <div class="mb-6">
                        <h2 class="text-lg font-semibold text-gray-900">Real-time Monitoring</h2>
                        <p class="text-sm text-gray-600 mt-1">Monitor aktivitas pengguna secara real-time</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Online Users -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded-full mr-2 online-indicator"></div>
                                Pengguna Online
                            </h3>
                            <div id="onlineUsersList" class="space-y-3">
                                <div class="text-center text-gray-500 py-4">Tidak ada pengguna online</div>
                            </div>
                        </div>
                        
                        <!-- Recent Activities -->
                        <div class="bg-white rounded-lg border border-gray-200 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Terbaru</h3>
                            <div id="recentActivities" class="space-y-3">
                                <div class="text-center text-gray-500 py-4">Belum ada aktivitas</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Laporan Tab -->
                <div id="laporanTab" class="p-6 hidden">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <div>
                            <h2 class="text-lg font-semibold text-gray-900">Laporan Presensi</h2>
                            <p class="text-sm text-gray-600 mt-1">Analisis kehadiran berdasarkan periode</p>
                        </div>
                        <div class="flex space-x-2">
                            <input type="date" id="filterDateStart" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <input type="date" id="filterDateEnd" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <button onclick="filterLaporan()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                                üìä Filter
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg p-6 mb-6 border border-gray-200">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <p class="text-2xl font-bold text-green-600" id="laporanHadir">0</p>
                                <p class="text-sm text-gray-600">Hadir</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <p class="text-2xl font-bold text-yellow-600" id="laporanTerlambat">0</p>
                                <p class="text-sm text-gray-600">Terlambat</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <p class="text-2xl font-bold text-red-600" id="laporanTidakHadir">0</p>
                                <p class="text-sm text-gray-600">Tidak Hadir</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow-sm">
                                <p class="text-2xl font-bold text-blue-600" id="laporanTotal">0</p>
                                <p class="text-sm text-gray-600">Total Record</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Masuk</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jam Keluar</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="laporanTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">Pilih rentang tanggal untuk melihat laporan</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Export Tab -->
                <div id="exportTab" class="p-6 hidden">
                    <div class="text-center py-12">
                        <div class="mb-6">
                            <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-green-600 text-2xl">üìä</span>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Export & Backup Data</h3>
                            <p class="text-gray-600">Kelola data presensi dengan berbagai format export</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-4xl mx-auto">
                            <button onclick="exportToExcel()" class="btn-primary text-white py-4 px-6 rounded-lg transition-all flex flex-col items-center space-y-2 card-hover">
                                <span class="text-2xl">üìã</span>
                                <span class="font-medium">Export ke Excel</span>
                                <span class="text-xs opacity-75">Format .xlsx</span>
                            </button>
                            <button onclick="exportToCSV()" class="bg-blue-600 text-white py-4 px-6 rounded-lg hover:bg-blue-700 transition-colors flex flex-col items-center space-y-2 card-hover">
                                <span class="text-2xl">üìÑ</span>
                                <span class="font-medium">Export ke CSV</span>
                                <span class="text-xs opacity-75">Format .csv</span>
                            </button>
                            <button onclick="exportToPDF()" class="bg-red-600 text-white py-4 px-6 rounded-lg hover:bg-red-700 transition-colors flex flex-col items-center space-y-2 card-hover">
                                <span class="text-2xl">üìë</span>
                                <span class="font-medium">Export ke PDF</span>
                                <span class="text-xs opacity-75">Format .pdf</span>
                            </button>
                            <button onclick="printReport()" class="bg-gray-600 text-white py-4 px-6 rounded-lg hover:bg-gray-700 transition-colors flex flex-col items-center space-y-2 card-hover">
                                <span class="text-2xl">üñ®Ô∏è</span>
                                <span class="font-medium">Print Laporan</span>
                                <span class="text-xs opacity-75">Cetak langsung</span>
                            </button>
                            <button onclick="syncToGoogleSheets()" class="bg-purple-600 text-white py-4 px-6 rounded-lg hover:bg-purple-700 transition-colors flex flex-col items-center space-y-2 card-hover">
                                <span class="text-2xl">‚òÅÔ∏è</span>
                                <span class="font-medium">Sync ke Sheets</span>
                                <span class="text-xs opacity-75">Google Sheets</span>
                            </button>
                            <button onclick="backupData()" class="bg-yellow-600 text-white py-4 px-6 rounded-lg hover:bg-yellow-700 transition-colors flex flex-col items-center space-y-2 card-hover">
                                <span class="text-2xl">üíæ</span>
                                <span class="font-medium">Backup Data</span>
                                <span class="text-xs opacity-75">File .json</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tukang Dashboard -->
    <div id="tukangPage" class="hidden min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b sticky top-0 z-40">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <div class="bg-gradient-to-br from-green-600 to-green-700 w-10 h-10 rounded-full flex items-center justify-center mr-3 shadow-lg">
                            <span class="text-white font-bold">B</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900">Dashboard Tukang</h1>
                            <p class="text-sm text-gray-600" id="tukangName">Selamat datang!</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="tukangConnectionStatus" class="flex items-center text-sm">
                            <div class="w-2 h-2 bg-green-500 rounded-full mr-2 online-indicator"></div>
                            <span>Online</span>
                        </div>
                        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Keluar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Status Card -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8 card-hover">
                <div class="text-center">
                    <div class="mb-4">
                        <div id="statusIcon" class="w-20 h-20 mx-auto rounded-full flex items-center justify-center text-3xl mb-4 bg-gray-100 shadow-lg">
                            ‚è∞
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900" id="statusText">Belum Presensi</h2>
                        <p class="text-gray-600 mt-2" id="currentDateTime"></p>
                        <div id="locationInfo" class="text-sm text-gray-500 mt-2"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <button onclick="presensiMasuk()" id="btnMasuk" class="btn-primary text-white py-3 px-6 rounded-lg font-medium transition-all flex items-center justify-center">
                            <span id="masukText">Presensi Masuk</span>
                            <div id="masukLoading" class="loading ml-2 hidden"></div>
                        </button>
                        <button onclick="presensiKeluar()" id="btnKeluar" class="bg-red-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-red-700 transition-colors disabled:bg-gray-400 flex items-center justify-center" disabled>
                            <span id="keluarText">Presensi Keluar</span>
                            <div id="keluarLoading" class="loading ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-lg shadow-sm p-4 text-center card-hover border-l-4 border-green-500">
                    <div class="text-2xl font-bold text-green-600" id="bulanIniHadir">0</div>
                    <div class="text-sm text-gray-600">Hadir Bulan Ini</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 text-center card-hover border-l-4 border-yellow-500">
                    <div class="text-2xl font-bold text-yellow-600" id="bulanIniTerlambat">0</div>
                    <div class="text-sm text-gray-600">Terlambat</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 text-center card-hover border-l-4 border-blue-500">
                    <div class="text-2xl font-bold text-blue-600" id="totalJamKerja">0</div>
                    <div class="text-sm text-gray-600">Jam Kerja</div>
                </div>
                <div class="bg-white rounded-lg shadow-sm p-4 text-center card-hover border-l-4 border-purple-500">
                    <div class="text-2xl font-bold text-purple-600" id="persentaseKehadiran">0%</div>
                    <div class="text-sm text-gray-600">Kehadiran</div>
                </div>
            </div>

            <!-- Riwayat Presensi -->
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Riwayat Presensi</h3>
                        <p class="text-sm text-gray-600 mt-1">7 hari terakhir</p>
                    </div>
                    <button onclick="loadRiwayatPresensi()" class="btn-primary text-white px-3 py-2 rounded-lg transition-all text-sm">
                        üîÑ Refresh
                    </button>
                </div>
                
                <div class="space-y-4" id="riwayatPresensi">
                    <div class="text-center text-gray-500 py-8">
                        <p>Memuat riwayat presensi...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Tukang -->
    <div id="addTukangModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <span class="mr-2">üë∑</span>
                    Tambah Tukang Baru
                </h3>
                <button onclick="hideAddTukangModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="text-xl">√ó</span>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="newTukangName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Masukkan nama lengkap">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="newTukangUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Masukkan username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="newTukangPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Masukkan password">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label>
                    <input type="tel" id="newTukangPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="08xxxxxxxxxx">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                    <textarea id="newTukangAddress" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" rows="3" placeholder="Masukkan alamat lengkap"></textarea>
                </div>
            </div>
            
            <div class="flex space-x-4 mt-6">
                <button onclick="hideAddTukangModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                    Batal
                </button>
                <button onclick="addTukang()" class="flex-1 btn-primary text-white py-2 rounded-lg transition-all">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Tambah Admin -->
    <div id="addAdminModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                    <span class="mr-2">üë®‚Äçüíº</span>
                    Tambah Admin Baru
                </h3>
                <button onclick="hideAddAdminModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <span class="text-xl">√ó</span>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                    <input type="text" id="newAdminName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Masukkan nama lengkap">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="newAdminUsername" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Masukkan username">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="newAdminPassword" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="Masukkan password">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="newAdminEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="admin@baznas.org">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                    <select id="newAdminRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                        <option value="Admin">Admin</option>
                        <option value="Super Admin">Super Admin</option>
                    </select>
                </div>
            </div>
            
            <div class="flex space-x-4 mt-6">
                <button onclick="hideAddAdminModal()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-colors">
                    Batal
                </button>
                <button onclick="addAdmin()" class="flex-1 btn-primary text-white py-2 rounded-lg transition-all">
                    Simpan
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        let GOOGLE_SHEETS_URL = localStorage.getItem('sheetsUrl') || '';
        
        // Data Storage
        let currentUser = null;
        let tukangData = [];
        let adminData = [];
        let presensiData = [];
        let onlineUsers = new Set();
        let activities = [];
        let currentTab = 'presensi';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistem Presensi BAZNAS Banyuwangi - Initialized');
            
            updateCurrentDate();
            updateCurrentDateTime();
            loadSavedUrl();
            
            // Set default date filters
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            
            const startInput = document.getElementById('filterDateStart');
            const endInput = document.getElementById('filterDateEnd');
            
            if (startInput) startInput.value = firstDay.toISOString().split('T')[0];
            if (endInput) endInput.value = lastDay.toISOString().split('T')[0];
            
            setInterval(updateCurrentDateTime, 1000);
            setInterval(checkConnection, 30000);
            setInterval(updateOnlineStatus, 5000);
            
            showToast('Sistem presensi siap digunakan!', 'success');
        });

        // Load saved URL and check if setup is completed
        function loadSavedUrl() {
            const savedUrl = localStorage.getItem('sheetsUrl');
            const setupCompleted = localStorage.getItem('setupCompleted');
            
            if (savedUrl) {
                GOOGLE_SHEETS_URL = savedUrl;
                document.getElementById('sheetsUrl').value = savedUrl;
                checkConnection();
                
                // Hide setup form if already completed
                if (setupCompleted === 'true') {
                    hideSetupForm();
                }
            }
        }

        // Hide setup form
        function hideSetupForm() {
            const setupForm = document.getElementById('setupForm');
            const showSetupBtn = document.getElementById('showSetupBtn');
            
            if (setupForm) {
                setupForm.classList.add('hidden-setup');
                setTimeout(() => {
                    setupForm.style.display = 'none';
                }, 500);
            }
            
            if (showSetupBtn) {
                showSetupBtn.classList.remove('hidden');
            }
        }

        // Show setup form
        function showSetupForm() {
            const setupForm = document.getElementById('setupForm');
            const showSetupBtn = document.getElementById('showSetupBtn');
            
            if (setupForm) {
                setupForm.style.display = 'block';
                setupForm.classList.remove('hidden-setup');
            }
            
            if (showSetupBtn) {
                showSetupBtn.classList.add('hidden');
            }
        }

        // Toast Notifications
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.className = `toast ${colors[type]} text-white p-4 rounded-lg shadow-lg flex items-center space-x-3`;
            toast.innerHTML = `
                <span class="text-xl">${icons[type]}</span>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">√ó</button>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, duration);
        }

        // Password Toggle
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                toggleIcon.textContent = 'üëÅÔ∏è';
            }
        }

        // Google Sheets API Functions
        async function callGoogleSheetsAPI(action, data = {}) {
            if (!GOOGLE_SHEETS_URL) {
                throw new Error('Google Sheets URL belum dikonfigurasi');
            }

            try {
                const url = new URL(GOOGLE_SHEETS_URL);
                url.searchParams.append('action', action);
                
                if (Object.keys(data).length > 0) {
                    Object.keys(data).forEach(key => {
                        url.searchParams.append(key, data[key]);
                    });
                }

                const response = await fetch(url.toString(), {
                    method: 'GET',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || result.message || 'Unknown error');
                }

                return result.data;
            } catch (error) {
                console.error('Google Sheets API Error:', error);
                throw error;
            }
        }

        async function postToGoogleSheets(action, data) {
            if (!GOOGLE_SHEETS_URL) {
                throw new Error('Google Sheets URL belum dikonfigurasi');
            }

            try {
                const response = await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || result.message || 'Unknown error');
                }

                return result;
            } catch (error) {
                console.error('Google Sheets POST Error:', error);
                throw error;
            }
        }

        // Load data from Google Sheets
        async function loadDataFromSheets() {
            try {
                showToast('Memuat data dari Google Sheets...', 'info');
                
                // Load Admin data
                const adminResult = await callGoogleSheetsAPI('getAdmin');
                adminData = adminResult || [];
                console.log('Admin data loaded:', adminData);
                
                // Load Tukang data
                const tukangResult = await callGoogleSheetsAPI('getTukang');
                tukangData = tukangResult || [];
                console.log('Tukang data loaded:', tukangData);
                
                // Load Presensi data
                const presensiResult = await callGoogleSheetsAPI('getPresensi');
                presensiData = presensiResult || [];
                console.log('Presensi data loaded:', presensiData);
                
                showToast('Data berhasil dimuat dari Google Sheets!', 'success');
                return true;
            } catch (error) {
                console.error('Error loading data from sheets:', error);
                showToast('Gagal memuat data dari Google Sheets: ' + error.message, 'error');
                return false;
            }
        }

        // Setup Functions
        async function testConnection() {
            const url = document.getElementById('sheetsUrl').value;
            if (!url) {
                showToast('Harap masukkan URL Google Apps Script terlebih dahulu!', 'error');
                return;
            }

            try {
                showToast('Testing koneksi...', 'info');
                
                const testUrl = new URL(url);
                testUrl.searchParams.append('action', 'test');
                
                const response = await fetch(testUrl.toString(), { 
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showToast('Koneksi berhasil! Google Sheets dapat diakses.', 'success');
                        return true;
                    } else {
                        throw new Error(result.message || 'Connection test failed');
                    }
                } else {
                    throw new Error('Connection failed');
                }
            } catch (error) {
                showToast('Koneksi gagal. Periksa URL dan pastikan script sudah di-deploy dengan benar.', 'error');
                return false;
            }
        }

        async function saveSetup() {
            const url = document.getElementById('sheetsUrl').value;
            if (!url) {
                showToast('Harap masukkan URL Google Apps Script!', 'error');
                return;
            }

            // Test connection first
            const connectionOk = await testConnection();
            if (!connectionOk) {
                return;
            }

            GOOGLE_SHEETS_URL = url;
            localStorage.setItem('sheetsUrl', url);
            localStorage.setItem('setupCompleted', 'true');
            checkConnection();
            
            // Hide setup form after successful save
            hideSetupForm();
            
            showToast('Konfigurasi berhasil disimpan dan disembunyikan!', 'success');
        }

        // Connection Status
        async function checkConnection() {
            const adminStatus = document.getElementById('connectionStatus');
            const tukangStatus = document.getElementById('tukangConnectionStatus');
            
            if (GOOGLE_SHEETS_URL) {
                try {
                    const testUrl = new URL(GOOGLE_SHEETS_URL);
                    testUrl.searchParams.append('action', 'test');
                    
                    const response = await fetch(testUrl.toString(), { 
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            if (adminStatus) {
                                adminStatus.innerHTML = '<div class="w-2 h-2 status-online rounded-full mr-2"></div><span>Terhubung</span>';
                            }
                            if (tukangStatus) {
                                tukangStatus.innerHTML = '<div class="w-2 h-2 status-online rounded-full mr-2 online-indicator"></div><span>Online</span>';
                            }
                        } else {
                            throw new Error('Connection test failed');
                        }
                    } else {
                        throw new Error('Connection failed');
                    }
                } catch (error) {
                    if (adminStatus) {
                        adminStatus.innerHTML = '<div class="w-2 h-2 status-warning rounded-full mr-2"></div><span>Mode Offline</span>';
                    }
                    if (tukangStatus) {
                        tukangStatus.innerHTML = '<div class="w-2 h-2 status-warning rounded-full mr-2"></div><span>Offline</span>';
                    }
                }
            } else {
                if (adminStatus) {
                    adminStatus.innerHTML = '<div class="w-2 h-2 status-offline rounded-full mr-2"></div><span>Tidak dikonfigurasi</span>';
                }
                if (tukangStatus) {
                    tukangStatus.innerHTML = '<div class="w-2 h-2 status-offline rounded-full mr-2"></div><span>Offline</span>';
                }
            }
        }

        // Authentication
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const loginText = document.getElementById('loginText');
            const loginLoading = document.getElementById('loginLoading');

            if (!username || !password) {
                showToast('Harap isi username dan password!', 'error');
                return;
            }

            if (!GOOGLE_SHEETS_URL) {
                showToast('Harap konfigurasi Google Sheets terlebih dahulu!', 'error');
                return;
            }

            // Show loading
            loginText.textContent = 'Memverifikasi...';
            loginLoading.classList.remove('hidden');
            loginBtn.disabled = true;

            try {
                // Load data from Google Sheets
                const dataLoaded = await loadDataFromSheets();
                if (!dataLoaded) {
                    throw new Error('Gagal memuat data dari Google Sheets');
                }

                // Debug login data
                console.log('Login attempt:', { username, password });
                console.log('Available admin data:', adminData);
                console.log('Available tukang data:', tukangData);

                // Check admin credentials with trimmed comparison
                const admin = adminData.find(a => {
                    const adminUsername = String(a.username || '').trim();
                    const adminPassword = String(a.password || '').trim();
                    console.log('Comparing admin:', { adminUsername, adminPassword, inputUsername: username, inputPassword: password });
                    return adminUsername === username && adminPassword === password;
                });
                
                if (admin) {
                    currentUser = { 
                        type: 'admin', 
                        username: admin.username,
                        name: admin.name,
                        email: admin.email,
                        role: admin.role
                    };
                    
                    // Add to online users
                    onlineUsers.add({
                        type: 'admin',
                        name: admin.name,
                        loginTime: new Date()
                    });
                    
                    // Log activity
                    logActivity('Login', `Admin ${admin.name} masuk ke sistem`);
                    
                    showAdminPage();
                    showToast(`Selamat datang, ${admin.name}!`, 'success');
                    return;
                }

                // Check tukang credentials with trimmed comparison
                const tukang = tukangData.find(t => {
                    const tukangUsername = String(t.username || '').trim();
                    const tukangPassword = String(t.password || '').trim();
                    console.log('Comparing tukang:', { tukangUsername, tukangPassword, inputUsername: username, inputPassword: password });
                    return tukangUsername === username && tukangPassword === password;
                });
                
                if (tukang) {
                    currentUser = { type: 'tukang', data: tukang };
                    
                    // Add to online users
                    onlineUsers.add({
                        type: 'tukang',
                        name: tukang.name,
                        loginTime: new Date()
                    });
                    
                    // Log activity
                    logActivity('Login', `Tukang ${tukang.name} masuk ke sistem`);
                    
                    showTukangPage();
                    showToast(`Selamat datang, ${tukang.name}!`, 'success');
                    return;
                }

                throw new Error('Username atau password salah!');
                
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                // Reset button
                loginText.textContent = 'Masuk';
                loginLoading.classList.add('hidden');
                loginBtn.disabled = false;
            }
        }

        function logout() {
            if (currentUser) {
                // Remove from online users
                onlineUsers.forEach(user => {
                    if ((currentUser.type === 'admin' && user.name === currentUser.name) ||
                        (currentUser.type === 'tukang' && user.name === currentUser.data.name)) {
                        onlineUsers.delete(user);
                    }
                });
                
                // Log activity
                const userName = currentUser.type === 'admin' ? currentUser.name : currentUser.data.name;
                logActivity('Logout', `${currentUser.type === 'admin' ? 'Admin' : 'Tukang'} ${userName} keluar dari sistem`);
            }
            
            currentUser = null;
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('adminPage').classList.add('hidden');
            document.getElementById('tukangPage').classList.add('hidden');
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showToast('Anda telah logout', 'info');
        }

        // Activity Logging
        function logActivity(type, description) {
            activities.unshift({
                id: Date.now(),
                type: type,
                description: description,
                timestamp: new Date(),
                user: currentUser ? (currentUser.type === 'admin' ? currentUser.name : currentUser.data.name) : 'System'
            });
            
            // Keep only last 50 activities
            if (activities.length > 50) {
                activities = activities.slice(0, 50);
            }
            
            updateRecentActivities();
        }

        // Online Status Management
        function updateOnlineStatus() {
            if (currentUser) {
                // Update online indicator for current user
                const now = new Date();
                onlineUsers.forEach(user => {
                    if ((currentUser.type === 'admin' && user.name === currentUser.name) ||
                        (currentUser.type === 'tukang' && user.name === currentUser.data.name)) {
                        user.lastSeen = now;
                    }
                });
                
                updateOnlineUsersList();
            }
        }

        function updateOnlineUsersList() {
            const container = document.getElementById('onlineUsersList');
            const countElement = document.getElementById('onlineCount');
            
            if (!container || !countElement) return;
            
            const onlineArray = Array.from(onlineUsers);
            countElement.textContent = onlineArray.length;
            
            if (onlineArray.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Tidak ada pengguna online</div>';
                return;
            }
            
            container.innerHTML = onlineArray.map(user => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                            <span class="text-green-600 text-sm font-medium">${user.name.charAt(0)}</span>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${user.name}</p>
                            <p class="text-xs text-gray-500">${user.type === 'admin' ? 'Administrator' : 'Tukang'}</p>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <div class="w-2 h-2 bg-green-500 rounded-full mr-2 online-indicator"></div>
                        <span class="text-xs text-gray-500">Online</span>
                    </div>
                </div>
            `).join('');
        }

        function updateRecentActivities() {
            const container = document.getElementById('recentActivities');
            if (!container) return;
            
            if (activities.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">Belum ada aktivitas</div>';
                return;
            }
            
            container.innerHTML = activities.slice(0, 10).map(activity => `
                <div class="flex items-start space-x-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-blue-600 text-xs">
                            ${activity.type === 'Login' ? 'üîë' : 
                              activity.type === 'Logout' ? 'üö™' : 
                              activity.type === 'Presensi' ? '‚úÖ' : 'üìù'}
                        </span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900">${activity.type}</p>
                        <p class="text-xs text-gray-600">${activity.description}</p>
                        <p class="text-xs text-gray-400 mt-1">${activity.timestamp.toLocaleString('id-ID')}</p>
                    </div>
                </div>
            `).join('');
        }

        // Page Navigation
        function showAdminPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('adminPage').classList.remove('hidden');
            
            setTimeout(() => {
                updateAdminStats();
                loadPresensiTable();
                loadTukangGrid();
                loadAdminGrid();
                updateOnlineUsersList();
                updateRecentActivities();
                checkConnection();
            }, 100);
        }

        function showTukangPage() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('tukangPage').classList.remove('hidden');
            document.getElementById('tukangName').textContent = `Selamat datang, ${currentUser.data.name}!`;
            
            setTimeout(() => {
                updateTukangStatus();
                loadRiwayatPresensi();
                updateTukangStats();
                checkConnection();
            }, 100);
        }

        // Admin Functions
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('[id^="tab"]').forEach(tab => {
                tab.className = 'py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 whitespace-nowrap';
            });
            
            const activeTab = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
            if (activeTab) {
                activeTab.className = 'py-4 px-1 border-b-2 border-green-500 font-medium text-sm text-green-600 whitespace-nowrap';
            }
            
            // Hide all tabs
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`${tabName}Tab`);
            if (selectedTab) {
                selectedTab.classList.remove('hidden');
            }
            
            currentTab = tabName;
            
            // Load tab-specific data
            if (tabName === 'presensi') {
                loadPresensiTable();
            } else if (tabName === 'tukang') {
                loadTukangGrid();
            } else if (tabName === 'admin') {
                loadAdminGrid();
            } else if (tabName === 'monitoring') {
                updateOnlineUsersList();
                updateRecentActivities();
            } else if (tabName === 'laporan') {
                filterLaporan();
            }
        }

        function updateAdminStats() {
            const today = new Date().toLocaleDateString('id-ID');
            const todayPresensi = presensiData.filter(p => p.tanggal === today);
            
            document.getElementById('totalTukang').textContent = tukangData.length;
            document.getElementById('hadirHariIni').textContent = todayPresensi.filter(p => p.status === 'Hadir' || p.status === 'Terlambat').length;
            document.getElementById('terlambat').textContent = todayPresensi.filter(p => p.status === 'Terlambat').length;
            document.getElementById('tidakHadir').textContent = tukangData.length - todayPresensi.length;
        }

        function loadPresensiTable() {
            const tbody = document.getElementById('presensiTableBody');
            const today = new Date().toLocaleDateString('id-ID');
            const todayPresensi = presensiData.filter(p => p.tanggal === today);
            
            if (todayPresensi.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Belum ada data presensi hari ini</td></tr>';
                return;
            }
            
            tbody.innerHTML = todayPresensi.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                <span class="text-green-600 text-sm font-medium">${p.nama.charAt(0)}</span>
                            </div>
                            <div class="text-sm font-medium text-gray-900">${p.nama}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.jamMasuk}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.jamKeluar || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            p.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                            p.status === 'Terlambat' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${p.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.lokasi}</td>
                </tr>
            `).join('');
        }

        function loadTukangGrid() {
            const grid = document.getElementById('tukangGrid');
            
            if (tukangData.length === 0) {
                grid.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">Belum ada data tukang</p></div>';
                return;
            }
            
            grid.innerHTML = tukangData.map(tukang => `
                <div class="bg-white rounded-lg shadow-sm p-6 card-hover border border-gray-200">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mr-4">
                            <span class="text-green-600 font-semibold">${tukang.name.charAt(0)}</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${tukang.name}</h3>
                            <p class="text-sm text-gray-600">ID: ${tukang.id}</p>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <p class="text-gray-600"><span class="font-medium">Username:</span> ${tukang.username}</p>
                        <p class="text-gray-600"><span class="font-medium">Telepon:</span> ${tukang.phone}</p>
                        <p class="text-gray-600"><span class="font-medium">Alamat:</span> ${tukang.address}</p>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="editTukang(${tukang.id})" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700 transition-colors">
                            Edit
                        </button>
                        <button onclick="deleteTukang(${tukang.id})" class="flex-1 bg-red-600 text-white py-2 px-3 rounded text-sm hover:bg-red-700 transition-colors">
                            Hapus
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function loadAdminGrid() {
            const grid = document.getElementById('adminGrid');
            
            if (adminData.length === 0) {
                grid.innerHTML = '<div class="text-center py-8 col-span-full"><p class="text-gray-500">Belum ada data admin</p></div>';
                return;
            }
            
            grid.innerHTML = adminData.map(admin => `
                <div class="bg-white rounded-lg shadow-sm p-6 card-hover border border-gray-200">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mr-4">
                            <span class="text-blue-600 font-semibold">${admin.name.charAt(0)}</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">${admin.name}</h3>
                            <p class="text-sm text-gray-600">${admin.role}</p>
                        </div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <p class="text-gray-600"><span class="font-medium">Username:</span> ${admin.username}</p>
                        <p class="text-gray-600"><span class="font-medium">Email:</span> ${admin.email}</p>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="editAdmin('${admin.username}')" class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm hover:bg-blue-700 transition-colors">
                            Edit
                        </button>
                        <button onclick="deleteAdmin('${admin.username}')" class="flex-1 bg-red-600 text-white py-2 px-3 rounded text-sm hover:bg-red-700 transition-colors">
                            Hapus
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Modal Functions
        function showAddTukangModal() {
            document.getElementById('addTukangModal').classList.remove('hidden');
        }

        function hideAddTukangModal() {
            document.getElementById('addTukangModal').classList.add('hidden');
            // Clear form
            document.getElementById('newTukangName').value = '';
            document.getElementById('newTukangUsername').value = '';
            document.getElementById('newTukangPassword').value = '';
            document.getElementById('newTukangPhone').value = '';
            document.getElementById('newTukangAddress').value = '';
        }

        function showAddAdminModal() {
            document.getElementById('addAdminModal').classList.remove('hidden');
        }

        function hideAddAdminModal() {
            document.getElementById('addAdminModal').classList.add('hidden');
            // Clear form
            document.getElementById('newAdminName').value = '';
            document.getElementById('newAdminUsername').value = '';
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('newAdminEmail').value = '';
            document.getElementById('newAdminRole').value = 'Admin';
        }

        // CRUD Functions
        async function addTukang() {
            const name = document.getElementById('newTukangName').value.trim();
            const username = document.getElementById('newTukangUsername').value.trim();
            const password = document.getElementById('newTukangPassword').value.trim();
            const phone = document.getElementById('newTukangPhone').value.trim();
            const address = document.getElementById('newTukangAddress').value.trim();

            if (!name || !username || !password || !phone || !address) {
                showToast('Harap isi semua field!', 'error');
                return;
            }

            // Check if username already exists
            if (tukangData.find(t => t.username === username)) {
                showToast('Username sudah digunakan!', 'error');
                return;
            }

            try {
                const newTukang = {
                    id: Math.max(...tukangData.map(t => t.id), 0) + 1,
                    name: name,
                    username: username,
                    password: password,
                    phone: phone,
                    address: address
                };

                // Save to Google Sheets
                await postToGoogleSheets('addTukang', newTukang);
                
                tukangData.push(newTukang);
                loadTukangGrid();
                updateAdminStats();
                hideAddTukangModal();
                
                logActivity('CRUD', `Admin menambahkan tukang baru: ${name}`);
                showToast('Tukang berhasil ditambahkan!', 'success');
            } catch (error) {
                showToast('Gagal menambahkan tukang: ' + error.message, 'error');
            }
        }

        async function addAdmin() {
            const name = document.getElementById('newAdminName').value.trim();
            const username = document.getElementById('newAdminUsername').value.trim();
            const password = document.getElementById('newAdminPassword').value.trim();
            const email = document.getElementById('newAdminEmail').value.trim();
            const role = document.getElementById('newAdminRole').value;

            if (!name || !username || !password || !email) {
                showToast('Harap isi semua field!', 'error');
                return;
            }

            // Check if username already exists
            if (adminData.find(a => a.username === username)) {
                showToast('Username sudah digunakan!', 'error');
                return;
            }

            try {
                const newAdmin = {
                    name: name,
                    username: username,
                    password: password,
                    email: email,
                    role: role
                };

                // Save to Google Sheets
                await postToGoogleSheets('addAdmin', newAdmin);
                
                adminData.push(newAdmin);
                loadAdminGrid();
                hideAddAdminModal();
                
                logActivity('CRUD', `Admin menambahkan admin baru: ${name}`);
                showToast('Admin berhasil ditambahkan!', 'success');
            } catch (error) {
                showToast('Gagal menambahkan admin: ' + error.message, 'error');
            }
        }

        function editTukang(id) {
            const tukang = tukangData.find(t => t.id === id);
            if (tukang) {
                showToast(`Edit tukang: ${tukang.name}`, 'info');
                // Implementation for edit modal
            }
        }

        function editAdmin(username) {
            const admin = adminData.find(a => a.username === username);
            if (admin) {
                showToast(`Edit admin: ${admin.name}`, 'info');
                // Implementation for edit modal
            }
        }

        async function deleteTukang(id) {
            if (confirm('Apakah Anda yakin ingin menghapus tukang ini?')) {
                try {
                    const tukang = tukangData.find(t => t.id === id);
                    
                    // Delete from Google Sheets
                    await postToGoogleSheets('deleteTukang', { id: id });
                    
                    tukangData = tukangData.filter(t => t.id !== id);
                    loadTukangGrid();
                    updateAdminStats();
                    
                    logActivity('CRUD', `Admin menghapus tukang: ${tukang.name}`);
                    showToast('Tukang berhasil dihapus!', 'success');
                } catch (error) {
                    showToast('Gagal menghapus tukang: ' + error.message, 'error');
                }
            }
        }

        async function deleteAdmin(username) {
            if (username === currentUser.username) {
                showToast('Tidak dapat menghapus akun sendiri!', 'error');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus admin ini?')) {
                try {
                    const admin = adminData.find(a => a.username === username);
                    
                    // Delete from Google Sheets
                    await postToGoogleSheets('deleteAdmin', { username: username });
                    
                    adminData = adminData.filter(a => a.username !== username);
                    loadAdminGrid();
                    
                    logActivity('CRUD', `Admin menghapus admin: ${admin.name}`);
                    showToast('Admin berhasil dihapus!', 'success');
                } catch (error) {
                    showToast('Gagal menghapus admin: ' + error.message, 'error');
                }
            }
        }

        function filterLaporan() {
            const startDate = document.getElementById('filterDateStart').value;
            const endDate = document.getElementById('filterDateEnd').value;
            
            if (!startDate || !endDate) {
                showToast('Harap pilih rentang tanggal!', 'error');
                return;
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            const filteredData = presensiData.filter(p => {
                const presensiDate = new Date(p.date);
                return presensiDate >= start && presensiDate <= end;
            });
            
            // Update summary stats
            document.getElementById('laporanHadir').textContent = filteredData.filter(p => p.status === 'Hadir').length;
            document.getElementById('laporanTerlambat').textContent = filteredData.filter(p => p.status === 'Terlambat').length;
            document.getElementById('laporanTidakHadir').textContent = filteredData.filter(p => p.status === 'Tidak Hadir').length;
            document.getElementById('laporanTotal').textContent = filteredData.length;
            
            // Update table
            const tbody = document.getElementById('laporanTableBody');
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">Tidak ada data pada periode ini</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.map(p => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.tanggal}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${p.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.jamMasuk}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${p.jamKeluar || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            p.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                            p.status === 'Terlambat' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${p.status}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        async function refreshData() {
            try {
                showToast('Memuat ulang data...', 'info');
                await loadDataFromSheets();
                updateAdminStats();
                loadPresensiTable();
                loadTukangGrid();
                loadAdminGrid();
                showToast('Data berhasil direfresh!', 'success');
            } catch (error) {
                showToast('Gagal memuat ulang data: ' + error.message, 'error');
            }
        }

        // Tukang Functions
        function updateTukangStatus() {
            const today = new Date().toLocaleDateString('id-ID');
            const todayPresensi = presensiData.find(p => 
                p.tukangId === currentUser.data.id && p.tanggal === today
            );
            
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const btnMasuk = document.getElementById('btnMasuk');
            const btnKeluar = document.getElementById('btnKeluar');
            
            if (!todayPresensi) {
                statusIcon.innerHTML = '‚è∞';
                statusIcon.className = 'w-20 h-20 mx-auto rounded-full flex items-center justify-center text-3xl mb-4 bg-gray-100 shadow-lg';
                statusText.textContent = 'Belum Presensi';
                btnMasuk.disabled = false;
                btnKeluar.disabled = true;
            } else if (todayPresensi.jamKeluar) {
                statusIcon.innerHTML = '‚úÖ';
                statusIcon.className = 'w-20 h-20 mx-auto rounded-full flex items-center justify-center text-3xl mb-4 bg-green-100 shadow-lg';
                statusText.textContent = 'Presensi Selesai';
                btnMasuk.disabled = true;
                btnKeluar.disabled = true;
            } else {
                statusIcon.innerHTML = 'üè¢';
                statusIcon.className = 'w-20 h-20 mx-auto rounded-full flex items-center justify-center text-3xl mb-4 bg-blue-100 shadow-lg';
                statusText.textContent = 'Sedang Bekerja';
                btnMasuk.disabled = true;
                btnKeluar.disabled = false;
            }
        }

        async function presensiMasuk() {
            const btnMasuk = document.getElementById('btnMasuk');
            const masukText = document.getElementById('masukText');
            const masukLoading = document.getElementById('masukLoading');
            
            masukText.textContent = 'Memproses...';
            masukLoading.classList.remove('hidden');
            btnMasuk.disabled = true;
            
            try {
                const now = new Date();
                const jamMasuk = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const status = now.getHours() > 8 || (now.getHours() === 8 && now.getMinutes() > 0) ? 'Terlambat' : 'Hadir';
                
                // Get location
                let lokasi = 'Lokasi tidak tersedia';
                try {
                    const position = await getCurrentPosition();
                    lokasi = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                } catch (error) {
                    console.log('Location not available:', error);
                }
                
                const presensiRecord = {
                    id: Date.now(),
                    tukangId: currentUser.data.id,
                    nama: currentUser.data.name,
                    date: now,
                    jamMasuk: jamMasuk,
                    jamKeluar: '',
                    status: status,
                    lokasi: lokasi,
                    tanggal: now.toLocaleDateString('id-ID')
                };
                
                // Save to Google Sheets
                await postToGoogleSheets('addPresensi', presensiRecord);
                
                presensiData.push(presensiRecord);
                
                updateTukangStatus();
                loadRiwayatPresensi();
                updateTukangStats();
                
                logActivity('Presensi', `${currentUser.data.name} melakukan presensi masuk - Status: ${status}`);
                showToast(`Presensi masuk berhasil! Status: ${status}`, 'success');
                
            } catch (error) {
                showToast('Gagal melakukan presensi masuk: ' + error.message, 'error');
            } finally {
                masukText.textContent = 'Presensi Masuk';
                masukLoading.classList.add('hidden');
            }
        }

        async function presensiKeluar() {
            const btnKeluar = document.getElementById('btnKeluar');
            const keluarText = document.getElementById('keluarText');
            const keluarLoading = document.getElementById('keluarLoading');
            
            keluarText.textContent = 'Memproses...';
            keluarLoading.classList.remove('hidden');
            btnKeluar.disabled = true;
            
            try {
                const now = new Date();
                const jamKeluar = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const today = now.toLocaleDateString('id-ID');
                
                // Find today's presensi record
                const todayPresensi = presensiData.find(p => 
                    p.tukangId === currentUser.data.id && p.tanggal === today
                );
                
                if (todayPresensi) {
                    todayPresensi.jamKeluar = jamKeluar;
                    
                    // Update in Google Sheets
                    await postToGoogleSheets('updatePresensi', {
                        id: todayPresensi.id,
                        jamKeluar: jamKeluar
                    });
                    
                    updateTukangStatus();
                    loadRiwayatPresensi();
                    updateTukangStats();
                    
                    logActivity('Presensi', `${currentUser.data.name} melakukan presensi keluar`);
                    showToast('Presensi keluar berhasil!', 'success');
                } else {
                    showToast('Data presensi masuk tidak ditemukan!', 'error');
                }
                
            } catch (error) {
                showToast('Gagal melakukan presensi keluar: ' + error.message, 'error');
            } finally {
                keluarText.textContent = 'Presensi Keluar';
                keluarLoading.classList.add('hidden');
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation not supported'));
                    return;
                }
                
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                });
            });
        }

        function loadRiwayatPresensi() {
            const container = document.getElementById('riwayatPresensi');
            const userPresensi = presensiData
                .filter(p => p.tukangId === currentUser.data.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 7);
            
            if (userPresensi.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><p>Belum ada riwayat presensi</p></div>';
                return;
            }
            
            container.innerHTML = userPresensi.map(p => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center mr-4 ${
                            p.status === 'Hadir' ? 'bg-green-100 text-green-600' :
                            p.status === 'Terlambat' ? 'bg-yellow-100 text-yellow-600' :
                            'bg-red-100 text-red-600'
                        }">
                            ${p.status === 'Hadir' ? '‚úÖ' : p.status === 'Terlambat' ? '‚è∞' : '‚ùå'}
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">${p.tanggal}</p>
                            <p class="text-sm text-gray-600">${p.jamMasuk} - ${p.jamKeluar || 'Belum keluar'}</p>
                        </div>
                    </div>
                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                        p.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                        p.status === 'Terlambat' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-red-100 text-red-800'
                    }">
                        ${p.status}
                    </span>
                </div>
            `).join('');
        }

        function updateTukangStats() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyPresensi = presensiData.filter(p => {
                const presensiDate = new Date(p.date);
                return p.tukangId === currentUser.data.id && 
                       presensiDate.getMonth() === currentMonth && 
                       presensiDate.getFullYear() === currentYear;
            });
            
            const hadir = monthlyPresensi.filter(p => p.status === 'Hadir' || p.status === 'Terlambat').length;
            const terlambat = monthlyPresensi.filter(p => p.status === 'Terlambat').length;
            
            // Calculate total work hours
            let totalHours = 0;
            monthlyPresensi.forEach(p => {
                if (p.jamMasuk && p.jamKeluar) {
                    const masuk = new Date(`2000-01-01 ${p.jamMasuk}`);
                    const keluar = new Date(`2000-01-01 ${p.jamKeluar}`);
                    const diff = (keluar - masuk) / (1000 * 60 * 60);
                    if (diff > 0) totalHours += diff;
                }
            });
            
            const workingDays = new Date(currentYear, currentMonth + 1, 0).getDate();
            const attendancePercentage = Math.round((hadir / workingDays) * 100);
            
            document.getElementById('bulanIniHadir').textContent = hadir;
            document.getElementById('bulanIniTerlambat').textContent = terlambat;
            document.getElementById('totalJamKerja').textContent = Math.round(totalHours);
            document.getElementById('persentaseKehadiran').textContent = `${attendancePercentage}%`;
        }

        // Export Functions
        function exportToExcel() {
            try {
                const wb = XLSX.utils.book_new();
                
                // Presensi sheet
                const presensiSheet = XLSX.utils.json_to_sheet(presensiData.map(p => ({
                    'Tanggal': p.tanggal,
                    'Nama': p.nama,
                    'Jam Masuk': p.jamMasuk,
                    'Jam Keluar': p.jamKeluar || '-',
                    'Status': p.status,
                    'Lokasi': p.lokasi
                })));
                XLSX.utils.book_append_sheet(wb, presensiSheet, 'Presensi');
                
                // Tukang sheet
                const tukangSheet = XLSX.utils.json_to_sheet(tukangData.map(t => ({
                    'ID': t.id,
                    'Nama': t.name,
                    'Username': t.username,
                    'Telepon': t.phone,
                    'Alamat': t.address
                })));
                XLSX.utils.book_append_sheet(wb, tukangSheet, 'Tukang');
                
                XLSX.writeFile(wb, `Presensi_BAZNAS_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.xlsx`);
                showToast('Data berhasil diekspor ke Excel!', 'success');
            } catch (error) {
                showToast('Gagal mengekspor ke Excel!', 'error');
            }
        }

        function exportToCSV() {
            try {
                const csvContent = [
                    ['Tanggal', 'Nama', 'Jam Masuk', 'Jam Keluar', 'Status', 'Lokasi'],
                    ...presensiData.map(p => [
                        p.tanggal,
                        p.nama,
                        p.jamMasuk,
                        p.jamKeluar || '-',
                        p.status,
                        p.lokasi
                    ])
                ].map(row => row.join(',')).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Presensi_BAZNAS_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.csv`;
                link.click();
                
                showToast('Data berhasil diekspor ke CSV!', 'success');
            } catch (error) {
                showToast('Gagal mengekspor ke CSV!', 'error');
            }
        }

        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text('Laporan Presensi BAZNAS Banyuwangi', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Tanggal: ${new Date().toLocaleDateString('id-ID')}`, 20, 35);
                
                let y = 50;
                presensiData.slice(0, 20).forEach(p => {
                    doc.text(`${p.tanggal} - ${p.nama} - ${p.jamMasuk} - ${p.status}`, 20, y);
                    y += 10;
                });
                
                doc.save(`Presensi_BAZNAS_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.pdf`);
                showToast('Data berhasil diekspor ke PDF!', 'success');
            } catch (error) {
                showToast('Gagal mengekspor ke PDF!', 'error');
            }
        }

        function printReport() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Laporan Presensi BAZNAS Banyuwangi</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .header { text-align: center; margin-bottom: 30px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>BAZNAS Banyuwangi</h1>
                        <h2>Laporan Presensi Tukang</h2>
                        <p>Tanggal: ${new Date().toLocaleDateString('id-ID')}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Tanggal</th>
                                <th>Nama</th>
                                <th>Jam Masuk</th>
                                <th>Jam Keluar</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${presensiData.map(p => `
                                <tr>
                                    <td>${p.tanggal}</td>
                                    <td>${p.nama}</td>
                                    <td>${p.jamMasuk}</td>
                                    <td>${p.jamKeluar || '-'}</td>
                                    <td>${p.status}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        async function syncToGoogleSheets() {
            try {
                showToast('Sinkronisasi ke Google Sheets...', 'info');
                
                // Sync all data to Google Sheets
                await postToGoogleSheets('syncAll', {
                    presensiData: presensiData,
                    tukangData: tukangData,
                    adminData: adminData
                });
                
                showToast('Sinkronisasi berhasil!', 'success');
            } catch (error) {
                showToast('Gagal sinkronisasi: ' + error.message, 'error');
            }
        }

        function backupData() {
            try {
                const backupData = {
                    presensiData,
                    tukangData,
                    adminData,
                    activities,
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `Backup_BAZNAS_${new Date().toLocaleDateString('id-ID').replace(/\//g, '-')}.json`;
                link.click();
                
                showToast('Backup data berhasil dibuat!', 'success');
            } catch (error) {
                showToast('Gagal membuat backup!', 'error');
            }
        }

        // Utility Functions
        function updateCurrentDate() {
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = new Date().toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        function updateCurrentDateTime() {
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = new Date().toLocaleString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9723d6028604e778',t:'MTc1NTcxMzMwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
